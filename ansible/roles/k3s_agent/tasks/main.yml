---
- name: Create systemd drop-in dir (even if no proxy)
  file:
    path: /etc/systemd/system/k3s-agent.service.d
    state: directory
    mode: "0755"

- name: Write systemd proxy env (if proxies provided)
  template:
    src: systemd-proxy.env.j2
    dest: /etc/systemd/system/k3s-agent.service.d/proxy.conf
    mode: "0644"
  when: http_proxy is defined or https_proxy is defined or (no_proxy is defined and (no_proxy | length > 0))
  notify:
    - systemd daemon-reload
    - Restart k3s-agent

- name: Install k3s agent via official script (idempotent)
  environment:
    INSTALL_K3S_CHANNEL: "{{ k3s_install_channel | default('stable') }}"
    INSTALL_K3S_VERSION: "{{ k3s_install_version | default('') }}"
  shell: |
    set -euo pipefail
    if ! command -v k3s >/dev/null 2>&1; then
      curl -sfL https://get.k3s.io | INSTALL_K3S_SKIP_START=true sh -s - agent
    fi
  args:
    creates: /usr/local/bin/k3s
    executable: /bin/bash

- name: Ensure config dir exists
  file:
    path: /etc/rancher/k3s
    state: directory
    mode: "0755"

- name: Write k3s registries (if defined)
  template:
    src: registries.yaml.j2
    dest: /etc/rancher/k3s/registries.yaml
    mode: "0644"
  when: k3s_registries is defined
  notify: Restart k3s-agent

- name: Render k3s agent config.yaml
  template:
    src: config.yaml.j2
    dest: /etc/rancher/k3s/config.yaml
    mode: "0644"
  notify: Restart k3s-agent
