---
# Install Percona Server for MySQL 8.0 on Debian/Ubuntu
- name: Check if mysql is installed
  command: mysql --version
  register: mysql_check
  changed_when: false
  failed_when: false

- name: Debug mysql_check result
  debug:
    var: mysql_check

- name: Install MySQL on Debian/Ubuntu
  when: mysql_check.rc != 0
  block:
    - name: Ensure prerequisites are present
      apt:
        name:
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present
        update_cache: true
      become: true

    - name: Download percona-release .deb
      get_url:
        url: https://repo.percona.com/apt/percona-release_latest.generic_all.deb
        dest: /tmp/percona-release_latest.generic_all.deb
        mode: "0644"
      become: true

    - name: Install percona-release
      apt:
        deb: /tmp/percona-release_latest.generic_all.deb
      become: true

    - name: Configure Percona repo (setup)
      command: percona-release setup {{ percona_mysql_repo_setup_token_debian }}
      register: percona_release_setup
      changed_when: "'Enabling the Percona' in percona_release_setup.stdout or percona_release_setup.rc == 0"
      become: true

    - name: Enable {{ percona_mysql_repo_channel }} release repo
      command: percona-release enable {{ percona_mysql_repo_channel }} release
      register: percona_release_enable
      changed_when: "'Enabling the Percona' in percona_release_enable.stdout or percona_release_enable.rc == 0"
      become: true

    - name: Update apt cache after enabling Percona repos
      apt:
        update_cache: true
      become: true

    - name: Install Percona server package (PS or PXC)
      apt:
        name: "{{ percona_mysql_package_server }}"
        state: present
      become: true
