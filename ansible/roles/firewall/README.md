## 1) `roles/firewall/defaults/main.yml`

```yaml
---
# ========== Policies & toggles ==========
fw_default_input_policy:  DROP        # drop unsolicited inbound
fw_default_output_policy: ACCEPT      # default allow egress (you can set DROP)
fw_allow_icmp:            true        # allow ICMPv4+v6 for PMTU/health
fw_replace:               true        # always replace ruleset atomically

# ========== Inbound rules ==========
# Schema: { proto: tcp|udp|icmp|icmpv6, port: <int>, src: <cidr>, action: accept|reject|drop, comment: <str> }
fw_inbound_rules: []

# Back-compat (DEPRECATED): merged into fw_inbound_rules for convenience
fw_extra_rules: []

# ========== Outbound rules ==========
# Schema: { proto: tcp|udp, port: <int>, dest: <cidr>, action: accept|reject|drop, comment: <str> }
fw_outbound_rules: []

# ========== Persistence ==========
# nftables persists via /etc/nftables.conf + service
fw_nft_conf_path: /etc/nftables.conf
```

---

## 2) `roles/firewall/tasks/main.yml`

```yaml
---
- name: Ensure nftables present
  package:
    name: nftables
    state: present

- name: (Optional) Disable legacy iptables-services if installed (avoid conflicts)
  service:
    name: iptables
    state: stopped
    enabled: false
  ignore_errors: true

- name: Ensure nftables service enabled
  service:
    name: nftables
    state: started
    enabled: true

# Render complete ruleset (IPv4+IPv6) using table inet + atomic load
- name: Render /etc/nftables.conf
  template:
    src: nftables.conf.j2
    dest: "{{ fw_nft_conf_path }}"
    owner: root
    group: root
    mode: '0644'

- name: Load ruleset atomically
  ansible.posix.nftables:
    state: present
    filename: "{{ fw_nft_conf_path }}"
```

> Notes:
>
> * We dropped all `ansible.builtin.iptables` tasks.
> * The `ansible.posix.nftables` call loads the whole file atomically—your desired “replace mode.”
> * We still honor `fw_extra_rules` by merging it into inbound rules in the template.

---

## 3) NEW: `roles/firewall/templates/nftables.conf.j2`

```jinja
#!/usr/sbin/nft -f
# Autogenerated by Ansible (role: firewall)
# Replace-mode: {{ fw_replace | default(true) }}

{% macro action_clause(rule_action) -%}
{{ rule_action | lower }}
{%- endmacro %}

{% macro reject_suffix(rule_action, proto='ip') -%}
{%- if rule_action|lower == 'reject' -%}
 reject with icmpx port-unreachable
{%- endif -%}
{%- endmacro %}

flush ruleset

table inet filter {
  # Optional service sets (extend as needed)
  sets {
    ssh_ports { type inet_service; elements = { 22 } }
  }

  chains {
    input {
      type filter hook input priority 0; policy {{ fw_default_input_policy | lower }};

      # loopback
      iif lo accept

      # keep established/related
      ct state established,related accept

      # ICMP/ICMPv6 (good for PMTU, diagnostics)
      {% if fw_allow_icmp %}
      ip protocol icmp accept
      ip6 nexthdr icmpv6 accept
      {% endif %}

      # Always allow SSH (baseline)
      tcp dport @ssh_ports accept

      # ---- Dynamic inbound rules ----
      {% set _in_rules = (fw_inbound_rules | default([])) + (fw_extra_rules | default([])) %}
      {% for r in _in_rules %}
      {% set act = (r.action | default('accept')) %}
      {% set cmt = (r.comment | default('inbound rule')) %}
      {% if r.proto in ['tcp','udp'] and r.port is defined %}
      {% if r.src is defined %}ip saddr {{ r.src }} {% endif %}{{ r.proto }} dport {{ r.port }} {{ action_clause(act) }}{{ reject_suffix(act) }} comment "{{ cmt }}"
      {% elif r.proto == 'icmp' %}
      ip protocol icmp {{ action_clause(act) }}{{ reject_suffix(act) }} comment "{{ cmt }}"
      {% elif r.proto == 'icmpv6' %}
      ip6 nexthdr icmpv6 {{ action_clause(act) }}{{ reject_suffix(act) }} comment "{{ cmt }}"
      {% endif %}
      {% endfor %}
    }

    output {
      type filter hook output priority 0; policy {{ fw_default_output_policy | lower }};

      # keep established/related fast-path
      ct state established,related accept

      # ---- Dynamic outbound rules ----
      {% for r in fw_outbound_rules | default([]) %}
      {% set act = (r.action | default('accept')) %}
      {% set cmt = (r.comment | default('outbound rule')) %}
      {% if r.proto in ['tcp','udp'] and r.port is defined %}
      {% if r.dest is defined %}ip daddr {{ r.dest }} {% endif %}{{ r.proto }} dport {{ r.port }} {{ action_clause(act) }}{{ reject_suffix(act) }} comment "{{ cmt }}"
      {% endif %}
      {% endfor %}
    }

    forward {
      type filter hook forward priority 0; policy drop;
    }
  }
}
```

**What this template does**

* Uses `table inet` so one config covers IPv4 & IPv6.
* Honors your defaults: input policy `DROP`, output policy configurable.
* Adds baseline safety: loopback, `ct state established,related`, ICMP/ICMPv6 if enabled, always SSH.
* Renders **actions** (`accept|reject|drop`) for both inbound & outbound; `reject` uses a sensible `icmpx port-unreachable`.
* Supports optional `src` (inbound) and `dest` (outbound) CIDRs.
* Loads **atomically** via `ansible.posix.nftables`.

---

## 4) `roles/firewall/README.md` (replace the top and variables sections)

````markdown
# Firewall Role (nftables)

This role configures a **modern nftables** firewall with atomic, replace-mode applies:

- Single ruleset for IPv4 + IPv6 (`table inet`).
- Default **INPUT** policy: `DROP` (configurable).
- Default **OUTPUT** policy: `ACCEPT` (configurable).
- Baseline allows: loopback, `ESTABLISHED,RELATED`, SSH.
- ICMP/ICMPv6 allowed by default (recommended; configurable).
- Extend with `fw_inbound_rules` and `fw_outbound_rules` (each rule supports `action`: `accept`, `reject`, `drop`).

## Requirements

- Ansible collection:
  ```bash
  ansible-galaxy collection install ansible.posix
````

## Variables

| Variable                   | Default              | Description                           |
| -------------------------- | -------------------- | ------------------------------------- |
| `fw_default_input_policy`  | `DROP`               | nft `input` chain policy              |
| `fw_default_output_policy` | `ACCEPT`             | nft `output` chain policy             |
| `fw_allow_icmp`            | `true`               | allow ICMPv4 + ICMPv6                 |
| `fw_replace`               | `true`               | always replace the ruleset atomically |
| `fw_inbound_rules`         | `[]`                 | list of inbound rules (see schema)    |
| `fw_outbound_rules`        | `[]`                 | list of outbound rules (see schema)   |
| `fw_nft_conf_path`         | `/etc/nftables.conf` | path to persisted config              |

### Rule schema

**Inbound**

```yaml
fw_inbound_rules:
  - { proto: tcp, port: 80, action: accept, comment: "HTTP" }
  - { proto: tcp, port: 23, action: reject, comment: "No Telnet" }
  - { proto: icmp, action: drop, comment: "Silence ping" }
  - { proto: tcp, port: 443, src: 10.0.0.0/8, action: accept, comment: "HTTPS from LAN" }
```

**Outbound**

```yaml
fw_outbound_rules:
  - { proto: udp, port: 53, action: accept, comment: "DNS" }
  - { proto: udp, port: 123, action: accept, comment: "NTP" }
  - { proto: tcp, port: 25, action: reject, comment: "Block SMTP egress" }
  - { proto: tcp, port: 443, dest: 0.0.0.0/0, action: accept, comment: "HTTPS" }
```

## Usage

```yaml
- hosts: all
  become: true
  roles:
    - role: firewall
      vars:
        fw_default_output_policy: DROP
        fw_outbound_rules:
          - { proto: udp, port: 53, action: accept, comment: "DNS" }
          - { proto: udp, port: 123, action: accept, comment: "NTP" }
          - { proto: tcp, port: 443, action: accept, comment: "HTTPS" }
        fw_inbound_rules:
          - { proto: tcp, port: 80,  action: accept, comment: "HTTP" }
          - { proto: tcp, port: 443, action: accept, comment: "HTTPS" }
```

## Notes

* The role **disables** `iptables` service if present to avoid conflicts.
* Apply is **atomic** via `ansible.posix.nftables` (no SSH lockout window).
* For more complex matching (interfaces, sets, ranges), extend the template.

