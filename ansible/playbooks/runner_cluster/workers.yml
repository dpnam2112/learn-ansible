- name: Provision k3s worker prerequisites
  hosts: gitlab-runner-k3s-worker
  become: true
  gather_facts: true
  tasks:
    - name: Ensure swap is off (runtime)
      command: swapoff -a
      when: ansible_swaptotal_mb | default(0) | int > 0
      changed_when: false

    - name: Disable swap persistently
      replace:
        path: /etc/fstab
        regexp: '^\s*([^#\s]+\s+)\S+\s+swap\s+'
        replace: '# \1none swap '
      register: swap_fstab
      notify: Reboot if kernel requires

    - name: Ensure br_netfilter loaded
      modprobe:
        name: br_netfilter
        state: present

    - name: Persist br_netfilter
      lineinfile:
        path: /etc/modules-load.d/k8s.conf
        create: true
        line: br_netfilter

    - name: Sysctl for Kubernetes networking
      copy:
        dest: /etc/sysctl.d/99-kubernetes-cri.conf
        content: |
          net.bridge.bridge-nf-call-iptables = 1
          net.bridge.bridge-nf-call-ip6tables = 1
          net.ipv4.ip_forward = 1
      notify: Reload sysctl

    - name: Ensure time sync present (chrony)
      package:
        name: chrony
        state: present

    - name: Enable & start chrony
      service:
        name: chronyd
        enabled: true
        state: started
  roles:
    - role: k3s_agent
  handlers:
    - name: Reload sysctl
      command: sysctl --system

    - name: Restart k3s-agent
      service:
        name: k3s-agent
        state: restarted

    - name: Reboot if kernel requires
      reboot:
        msg: "Reboot triggered by swap/fstab change"
        reboot_timeout: 600
      when: swap_fstab is changed
